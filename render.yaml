services:
  # 1. API Service
  - type: web
    name: lms-api
    env: docker
    plan: free
    dockerfilePath: ./backend/Dockerfile
    dockerContext: ./backend
    dockerCommand: npm run start
    numInstances: 1
    envVars:
      - key: PORT
        value: 5000
      # Redis kết nối bằng connectionString => HỢP LỆ
      - key: REDIS_URL
        fromService:
          type: redis
          name: lms-redis
          property: connectionString
      # (Đã xóa CLIENT_URL để tránh lỗi, sẽ thêm thủ công sau)

  # 2. Worker Service
  - type: worker
    name: lms-worker
    env: docker
    plan: free
    dockerfilePath: ./backend/Dockerfile
    dockerContext: ./backend
    dockerCommand: node src/service/aiWorkerService.js
    envVars: 
      - key: REDIS_URL
        fromService:
          type: redis
          name: lms-redis
          property: connectionString

databases:
  # 4. Redis Service
  - name: lms-redis
    plan: free
    ipAllowList: []
