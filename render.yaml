services:
  # 1. API Service (Chạy cả Web + Worker bên trong)
  - type: web
    name: lms-api
    env: docker
    plan: free
    image:
      registry: docker.io
      repository: trandokhanhminh/lms-backend:latest
      tag: latest
    # Đảm bảo lệnh này chạy file index.js đã import worker (như hướng dẫn trước)
    dockerCommand: npm run start
    numInstances: 1
    envVars:
      - key: PORT
        value: 5000
      # SỬA LẠI: Dùng fromService vì Redis được định nghĩa là service bên dưới
      - key: REDIS_URL
        fromService:
          type: redis
          name: lms-redis
          property: connectionString
      # (Nhớ thêm LIVEKIT_... và CLIENT_URL thủ công trên Dashboard)

  # 2. Redis Service (Key Value)
  # CHUYỂN TỪ databases LÊN ĐÂY
  - type: redis
    name: lms-redis
    plan: free
    ipAllowList: [] # Chỉ cho phép nội bộ truy cập

# Xóa mục databases đi vì không dùng PostgreSQL
